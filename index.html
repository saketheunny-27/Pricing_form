<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Surcharge Config</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f0f6ff; 
      color: #333;
    }
    h2 {
      color: #0d47a1;
    }
    label { 
      font-weight: bold; 
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"] {
      padding: 6px 10px;
      margin: 4px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      font-size: 14px;
    }
    input.invalid {
      border: 2px solid #d32f2f;
      background: #ffebee;
    }
    .validation-msg {
      color: #d32f2f;
      font-size: 12px;
      margin-top: -8px;
      margin-bottom: 8px;
      display: none;
    }
    .rules {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      border-left: 4px solid #1976d2;
    }
    .rules ul {
      margin: 5px 0;
      padding-left: 20px;
    }
    .rules li {
      margin: 3px 0;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      margin-right: 8px;
    }
    button:hover {
      background: #0d47a1;
    }
    .group { 
      background: white; 
      padding: 15px; 
      border-radius: 10px; 
      margin-bottom: 20px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    .state-checkboxes { 
      border: 1px solid #ccc; 
      padding: 10px; 
      max-height: 180px; 
      overflow-y: auto; 
      border-radius: 6px;
      background: #fafafa;
    }
    .state-checkboxes label { 
      display: block; 
      margin: 4px 0; 
      font-weight: normal; 
      font-size: 14px;
    }
    .controls {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h2>State Surcharge Config</h2>
  
  <div class="rules">
    <strong>Surcharge Code Rules:</strong>
    <ul>
      <li>✓ Maximum 3 characters (e.g., Z1, KR, HA3)</li>
      <li>✓ Only alphanumeric (letters and numbers)</li>
      <li>✓ Must contain at least ONE letter</li>
      <li>✓ No spaces or special characters</li>
      <li>✓ All letters must be UPPERCASE</li>
      <li>✗ Invalid: Z 3, KR_2, AMTN, kr2, 987, 3</li>
    </ul>
  </div>

  <div class="controls">
    <label>Number of surcharge categories: 
      <input type="number" id="numCats" min="1" max="10">
    </label>
    <button onclick="makeForm()">Generate Form</button>
  </div>

  <form id="configForm"></form>

  <button onclick="downloadCSV()">Download CSV</button>

  <script>
    const STATES = [
      "ANDHRA PRADESH","ARUNACHAL PRADESH","ASSAM","BIHAR","CHHATTISGARH",
      "DELHI","GOA","GUJARAT","HARYANA","HIMACHAL PRADESH","JAMMU AND KASHMIR",
      "JHARKHAND","KARNATAKA","KERALA","MADHYA PRADESH","MAHARASHTRA",
      "MANIPUR","MEGHALAYA","MIZORAM","NAGALAND","ODISHA","PUNJAB","RAJASTHAN",
      "SIKKIM","TAMIL NADU","TELANGANA","TRIPURA","UTTAR PRADESH","UTTARAKHAND",
      "WEST BENGAL"
    ];

    function makeStateSelect(id){
      const wrap = document.createElement('div');
      wrap.className = 'state-checkboxes';
      STATES.forEach(s => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = "checkbox";
        cb.value = s;
        cb.name = id;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + s));
        wrap.appendChild(label);
      });
      return wrap;
    }

    function makeForm(){
      const n = parseInt(document.getElementById('numCats').value);
      const form = document.getElementById('configForm');
      form.innerHTML = "";
      for(let i=0;i<n;i++){
        const div = document.createElement('div');
        div.className="group";
        div.innerHTML = `
          <label>Surcharge Code (e.g., Z${i+1}): 
            <input type="text" id="code${i}" value="Z${i+1}" maxlength="3">
          </label>
          <div class="validation-msg" id="error${i}">Invalid code format</div>
          <label>Price: 
            <input type="number" id="price${i}" step="0.01" value="0">
          </label>
          <p><strong>Select States:</strong></p>
        `;
        div.appendChild(makeStateSelect("states"+i));
        form.appendChild(div);
        
        // Add validation listener
        const input = document.getElementById("code"+i);
        input.addEventListener('input', function(e){
          validateSurchargeCode(i);
        });
      }
    }

    function validateSurchargeCode(index){
      const input = document.getElementById("code"+index);
      const error = document.getElementById("error"+index);
      let value = input.value;
      
      // Auto-uppercase
      value = value.toUpperCase();
      input.value = value;
      
      // Validation regex: 1-3 alphanumeric characters, must contain at least one letter
      const regex = /^(?=.*[A-Z])[A-Z0-9]{1,3}$/;
      
      if(!value){
        input.classList.remove('invalid');
        error.style.display = 'none';
        return false;
      }
      
      if(!regex.test(value)){
        input.classList.add('invalid');
        error.style.display = 'block';
        
        // Specific error messages
        if(value.length > 3){
          error.textContent = 'Maximum 3 characters allowed';
        } else if(/\s/.test(value)){
          error.textContent = 'No spaces allowed';
        } else if(/[^A-Z0-9]/.test(value)){
          error.textContent = 'Only letters and numbers allowed';
        } else if(/^[0-9]+$/.test(value)){
          error.textContent = 'Must contain at least one letter';
        } else {
          error.textContent = 'Invalid code format';
        }
        return false;
      }
      
      input.classList.remove('invalid');
      error.style.display = 'none';
      return true;
    }

    function getConfig(){
      const form = document.getElementById('configForm');
      const groups = form.getElementsByClassName('group');
      const map = {};
      const prices = {};
      const dups = [];
      let hasInvalid = false;
      
      for(let i=0;i<groups.length;i++){
        const code = document.getElementById("code"+i).value.trim().toUpperCase();
        const price = document.getElementById("price"+i).value.trim();
        
        // Check if code is empty
        if(!code){
          alert("Please enter a surcharge code for category " + (i+1));
          return null;
        }
        
        // Validate the code format
        if(!validateSurchargeCode(i)){
          hasInvalid = true;
          continue;
        }
        
        const sel = groups[i].querySelector('.state-checkboxes');
        sel.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>{
          const state = cb.value.toUpperCase();
          if(map[state] && map[state] !== code){
            dups.push(state);
          }
          map[state] = code;
          prices[state] = price;
        });
      }
      
      if(hasInvalid){
        alert("Please fix invalid surcharge codes before downloading");
        return null;
      }
      
      if(dups.length>0){
        alert("Warning: Duplicate states across categories: " + dups.join(", "));
      }
      return {map, prices};
    }

    function downloadCSV(){
      const config = getConfig();
      if(!config) return; // Validation failed
      
      const {map, prices} = config;
      let csv = "state,surcharge,price\n";
      for(const [state, code] of Object.entries(map)){
        csv += `${state},${code},${prices[state]}\n`;
      }
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "surcharge_states.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
